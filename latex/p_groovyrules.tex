\hypertarget{p_groovyrules_groovyrules}{}\doxysection{Groovy}\label{p_groovyrules_groovyrules}
Beast comes delivered with support for creating scriptable rules by using the groovy language. Groovy is very similar to java so most of the things you can do in java you will be able to do in groovy as well. There are a few caveats to this as usual. One of them is that it isn\textquotesingle{}t possible to create arrays by writing new String\mbox{[}\mbox{]}\{\char`\"{}a\char`\"{}, \char`\"{}b\} which might cause some problems when creating the \textbackslash{}ref eu.\+baltrad.\+beast.\+message.\+mo.\+Blt\+Generate\+Message. \+Instead, you should write \mbox{[}\char`\"{}a\char`\"{}, \char`\"{}b\char`\"{}\mbox{]} as String\mbox{[}$\,$\mbox{]}.  @subsection groovyrules\+\_\+why Why? \+Groovy is a scriptable language and it is similar to java which the beast library has been written in so it felt like the obvious choice.  @subsection groovyrules\+\_\+how How? \+This is a matter of programming and digging into the beast API documentation but in order to give you some ideas on how to progress the rest of this section will show you what can be done.  @subsubsection groovyrules\+\_\+how\+\_\+setup Setup IDE \+I have used a groovy plugin for eclipse for editing but you can just as well write the code in any java editor and perform the changes necessary for getting the code groovy compatible.  \+First of all, create a groovy project like with \char`\"{}File-\/\texorpdfstring{$>$}{>}New-\/\texorpdfstring{$>$}{>}Groovy Project\char`\"{}.  @image html new\+\_\+groovy\+\_\+project.\+jpg  \+After that, you will have to create a groovy class which is done with \char`\"{}File-\/\texorpdfstring{$>$}{>}New-\/\texorpdfstring{$>$}{>}Groovy Class\char`\"{}.  @image html new\+\_\+groovy\+\_\+class.\+jpg  \+Since you are going to use the beast API you need to setup the build path to include the beast.\+jar. Right click on your project and choose \char`\"{}Properties\char`\"{} and then \char`\"{}Java Build Path-\/\texorpdfstring{$>$}{>}Libraries-\/\texorpdfstring{$>$}{>}Add External JARs...\char`\"{}. Navigate to your beast library, probably something like \char`\"{}/opt/baltrad/beast/bin\char`\"{}.  \+Hopefully everything should be setup correctly now and it is time to write your own rule.  @subsubsection groovyrules\+\_\+how\+\_\+basics Basics  \+All scripted rules should implement the IScriptable\+Rule. So we start by importing the IScriptable\+Rule interface. If you have managed to setup eclipse properly you should be able to tab complete by writing IScript and then hit Ctrl-\/$<$\+Space$>$.  \+After that, you need to ensure that My\+Rule implements IScriptable\+Rule and adding the handle method, this will in turn require you to import the IBlt\+Message interface as well. After this you should have a basic rule that is runnable but won\textquotesingle{}t do anything.  @verbatim  import eu.\+baltrad.\+beast.\+message.\+IBlt\+Message; import eu.\+baltrad.\+beast.\+rules.\+IScriptable\+Rule  /$\ast$$\ast$  $\ast$ Rule for forwarding a specific area to the google maps  $\ast$ generator plugin  $\ast$ @author Anders Henja  $\ast$/ class GMap\+Rule implements IScriptable\+Rule \{   @\+Override   public IBlt\+Message handle(\+IBlt\+Message arg) \{     return null;   \} \} \textbackslash{}endverbatim  \+All rules are built like this, you get a IBlt\+Message and you can return a IBlt\+Message but you are not required to. If you return a IBlt\+Message you are saying that the framework needs to pass a  message on to an adaptor (basically an interface to an external resource). This is not true for all message types but most of them.  \+The currently supported messages can be found in the \textbackslash{}ref p\+\_\+message\+\_\+ib \char`\"{}Message Information Model\char`\"{}.  @subsubsection groovyrules\+\_\+how\+\_\+messages Messages \+As it is, all messages that arrives to the router will be sent to all registered rules. This means that you should always be careful to handle when the in argument is null or some unknown class. Since we only want to do something when the message is a Blt\+Data\+Message we probably should filter those out. \+Import Blt\+Data\+Message and add a check.  @verbatim  import eu.\+baltrad.\+beast.\+message.\+mo.\+Blt\+Data\+Message; ...    if (arg != null \&\& arg instanceof Blt\+Data\+Message) \{     Blt\+Data\+Message msg = (\+Blt\+Data\+Message)arg;     \} \textbackslash{}endverbatim  \+Next thing we want to do is to only process composites, i.\+e. /what/object == COMP and now it gets interesting since we are going to use the baltrad-\/db API for accessing meta data.  @subsubsection groovyrules\+\_\+how\+\_\+bdb Baltrad DB API  \+The Baltrad DB keeps track on all files and meta data. The Baltrad DB API tries to simplify the usage while also making sure that the db queries are optimized. The Blt\+Data\+Message has one method that returns a eu.\+baltrad.\+bdb.\+db.\+File\+Entry instance. But before you do anything else, open up the project properties and navigate to \char`\"{}Java Build Path-\/\texorpdfstring{$>$}{>}Libraries-\/\texorpdfstring{$>$}{>}Add External JARs...\char`\"{} and add the baltrad-\/bdb-\/client.\+jar file. Usually placed in @verbatim   /opt/baltrad/baltrad-\/db/share/baltrad-\/bdb/java/baltrad-\/bdb-\/client.\+jar \textbackslash{}endverbatim  \+Now, you can add a check if the file is a composite by fetching the what/object information from the meta data and making sure that it is \char`\"{}COMP\char`\"{}. Since we only want to execute the google  maps plugin for specific areas/sources. It probably is a good idea to add this check as well.  @verbatim  import eu.\+baltrad.\+bdb.\+db.\+File\+Entry; ...   File\+Entry entry = msg.\+get\+File\+Entry();   String object = entry.\+get\+Metadata().\+get\+What\+Object();   String source = entry.\+get\+Metadata().\+get\+What\+Source();   String area = get\+Supported\+Area(source);   if (object != null \&\& object.\+equals(\char`\"{}COMP\char`\"{}) \&\& area != null) \{    \} \textbackslash{}endverbatim  \+If you are using a somewhat competent IDE, you probably have got a error saying that get\+Supported\+Area is missing so you probably should implement this method. We only want to support swegmaps\+\_\+2000 and bltgmaps\+\_\+4000.  @verbatim    public static String\mbox{[}$\,$\mbox{]} AREAS=\mbox{[}\char`\"{}swegmaps\+\_\+2000\char`\"{}, \char`\"{}bltgmaps\+\_\+4000\char`\"{}\mbox{]}; // Note difference from java by using \mbox{[},\mbox{]} instead of \{\}      ....      protected String get\+Supported\+Area(\+String source) \{     if (source != null) \{       for (\+String s \+: AREAS) \{         if (source.\+index\+Of(s) $>$= 0) \{           return s;         \}       \}     \}     return null;   \}  \textbackslash{}endverbatim  \+According to the message information model the message to be used is \textbackslash{}ref s\+\_\+message\+\_\+ib\+\_\+generate. It requires files, arguments and what algorithm to use. \+By reading the documentation about the rave google maps plugin, it can be found that the registered algorithm is \textbackslash{}b se.\+smhi.\+rave.\+creategmapimage and that the required arguments are \mbox{[}\char`\"{}outfile\char`\"{}, $<$filename$>$\mbox{]} and a file.  \+Create a function that can generate the proper filename for you.  @verbatim  import eu.\+baltrad.\+bdb.\+util.\+Date; import eu.\+baltrad.\+bdb.\+util.\+Time; ...   public static String PATH=\char`\"{}/opt/baltrad/rave\+\_\+gmap/web/data\char`\"{};    protected String create\+Filename(\+Date d, Time t, String area) \{     String oname = PATH + \char`\"{}/\char`\"{}+area+\char`\"{}/\char`\"{} +        sprintf(\char`\"{}\%04d/\%02d/\%02d/\%04d\%02d\%02d\%02d\%02d\char`\"{},          \mbox{[}d.\+year(), d.\+month(), d.\+day(), d.\+year(), d.\+month(), d.\+day(), t.\+hour(), t.\+minute()\mbox{]} as int\mbox{[}$\,$\mbox{]}) + \char`\"{}.png\char`\"{};   \} \textbackslash{}endverbatim  \+We are almost there, now you only need to aquire the filename associated with the file entry, create the generate message and return it. In order to get the proper file name you will need to fetch a catalog instance from the manager context.  @verbatim  import eu.\+baltrad.\+beast.\+Manager\+Context; import eu.\+baltrad.\+beast.\+db.\+Catalog; ...   Catalog cat = Manager\+Context.\+get\+Catalog();   Date d = entry.\+get\+Metadata().\+get\+What\+Date();   Time t = entry.\+get\+Metadata().\+get\+What\+Time();   String ofile = create\+Filename(d, t, area);   result = new Blt\+Generate\+Message();   result.\+set\+Algorithm(\char`\"{}se.\+smhi.\+rave.\+creategmapimage\char`\"{});   result.\+set\+Files(\mbox{[}cat.\+get\+File\+Catalog\+Path(entry.\+get\+Uuid().\+to\+String())\mbox{]} as String\mbox{[}$\,$\mbox{]}); // Notice usage of as String\mbox{[}$\,$\mbox{]}   result.\+set\+Arguments(\mbox{[}\char`\"{}outfile\char`\"{}, ofile\mbox{]} as String\mbox{[}$\,$\mbox{]}); // Notice usage of as String\mbox{[}$\,$\mbox{]} \textbackslash{}endverbatim  \+Then, we just has to ensure that result is returned and test it out. The final result should look something like this.  @verbatim  /$\ast$ -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/ \+Copyright (\+C) 2009-\/2011 Swedish Meteorological and Hydrological Institute, SMHI,  \+This file is part of the Beast library.  \+Beast library is free software\+: you can redistribute it and/or modify it under the terms of the GNU Lesser General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.  \+Beast library is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of \+MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the \+GNU Lesser General Public License for more details.  \+You should have received a copy of the GNU Lesser General Public License along with the Beast library library.  If not, see $<$http\+://www.\+gnu.\+org/licenses/$>$. -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/$\ast$/ package se.\+smhi  import eu.\+baltrad.\+bdb.\+db.\+File\+Entry; import eu.\+baltrad.\+bdb.\+util.\+Date; import eu.\+baltrad.\+bdb.\+util.\+Time; import eu.\+baltrad.\+beast.\+Manager\+Context; import eu.\+baltrad.\+beast.\+db.\+Catalog; import eu.\+baltrad.\+beast.\+message.\+IBlt\+Message; import eu.\+baltrad.\+beast.\+rules.\+IScriptable\+Rule import eu.\+baltrad.\+beast.\+message.\+mo.\+Blt\+Data\+Message; import eu.\+baltrad.\+beast.\+message.\+mo.\+Blt\+Generate\+Message;  /$\ast$$\ast$  $\ast$ Rule for forwarding a specific area to the google maps  $\ast$ generator plugin.  $\ast$ @author Anders Henja  $\ast$/ class GMap\+Rule implements IScriptable\+Rule \{   public static String\mbox{[}$\,$\mbox{]} AREAS=\mbox{[}\char`\"{}swegmaps\+\_\+2000\char`\"{}, \char`\"{}bltgmaps\+\_\+4000\char`\"{}\mbox{]}; // Note difference from java by using \mbox{[},\mbox{]} instead of \{\}      public static String PATH=\char`\"{}/opt/baltrad/rave\+\_\+gmap/web/data\char`\"{};    /$\ast$$\ast$    $\ast$ Creates a file name to use      $\ast$ @param d the date    $\ast$ @param t the time    $\ast$ @param area the area    $\ast$ @return the full file name    $\ast$/   protected String create\+Filename(\+Date d, Time t, String area) \{     String oname = PATH + \char`\"{}/\char`\"{}+area+\char`\"{}/\char`\"{} +        sprintf(\char`\"{}\%04d/\%02d/\%02d/\%04d\%02d\%02d\%02d\%02d\char`\"{},          \mbox{[}d.\+year(), d.\+month(), d.\+day(), d.\+year(), d.\+month(), d.\+day(), t.\+hour(), t.\+minute()\mbox{]} as int\mbox{[}$\,$\mbox{]}) + \char`\"{}.png\char`\"{};   \}      /$\ast$$\ast$    $\ast$ Checks the source if it contains one of the strings in AREAS.    $\ast$ @param source the what/source string.    $\ast$ @return the found area or null    $\ast$/   protected String get\+Supported\+Area(\+String source) \{     if (source != null) \{       for (\+String s \+: AREAS) \{         if (source.\+index\+Of(s) $>$= 0) \{           return s;         \}       \}     \}     return null;   \}      @\+Override   public IBlt\+Message handle(\+IBlt\+Message arg) \{     Blt\+Generate\+Message result = null;     if (arg != null \&\& arg instanceof Blt\+Data\+Message) \{       Blt\+Data\+Message msg = (\+Blt\+Data\+Message)arg;       File\+Entry entry = msg.\+get\+File\+Entry();       String object = entry.\+get\+Metadata().\+get\+What\+Object();       String source = entry.\+get\+Metadata().\+get\+What\+Source();       String area = get\+Supported\+Area(source);       if (object != null \&\& object.\+equals(\char`\"{}COMP\char`\"{}) \&\& area != null) \{         Catalog cat = Manager\+Context.\+get\+Catalog();         Date d = entry.\+get\+Metadata().\+get\+What\+Date();         Time t = entry.\+get\+Metadata().\+get\+What\+Time();         String ofile = create\+Filename(d, t, area);         result = new Blt\+Generate\+Message();         result.\+set\+Algorithm(\char`\"{}se.\+smhi.\+rave.\+creategmapimage\char`\"{});         result.\+set\+Files(\mbox{[}cat.\+get\+File\+Catalog\+Path(entry.\+get\+Uuid().\+to\+String())\mbox{]} as String\mbox{[}$\,$\mbox{]}); // Notice usage of as String\mbox{[}$\,$\mbox{]}         result.\+set\+Arguments(\mbox{[}\char`\"{}outfile"{}, ofile\mbox{]} as String\mbox{[}\mbox{]}); // Notice usage of as String\mbox{[}\mbox{]} \} \} return result; \} \} 

You can find more examples on groovy scripts in the $<$beast install prefix$>$/examples directory. 